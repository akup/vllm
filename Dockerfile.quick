FROM vllm-openai

ENV VLLM_USE_V1=0

# Copy local code to temp location
COPY ./vllm /tmp/vllm-src

RUN python3 -m pip uninstall nvidia-nccl-cu12 -y && python3 -m pip install nvidia-nccl-cu12==2.26.2.post1

# Merge only .py files into existing vllm package (preserves .so files)
RUN cd /tmp/vllm-src \
    && find . -name "*.py" | tar -cf - -T - | tar -xf - -C /usr/local/lib/python3.12/dist-packages/vllm/ \
    && rm -rf /tmp/vllm-src
